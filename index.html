<!DOCTYPE html>
<html>
<head>
    <title>world-world editor</title>
    
    <!-- Farcaster Mini App Meta Tags -->
    <!-- TODO: Upload og-image.png to GitHub and replace this URL -->
    <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://raw.githubusercontent.com/compusophy/world-world/main/og-image.png","button":{"title":"ðŸŒ Open Editor","action":{"type":"launch_frame","name":"world-world","url":"https://world-world.vercel.app/","splashImageUrl":"https://raw.githubusercontent.com/compusophy/world-world/main/og-image.png","splashBackgroundColor":"#111111"}}}' />
    <!-- For backward compatibility -->
    <meta name="fc:frame" content='{"version":"1","imageUrl":"https://raw.githubusercontent.com/compusophy/world-world/main/og-image.png","button":{"title":"ðŸŒ Open Editor","action":{"type":"launch_frame","name":"world-world","url":"https://world-world.vercel.app/","splashImageUrl":"https://raw.githubusercontent.com/compusophy/world-world/main/og-image.png","splashBackgroundColor":"#111111"}}}' />
    
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
    <h1>world-world</h1>

    <form hx-post="/auth" hx-target="#status" hx-swap="innerHTML">
        <input type="password" name="token" placeholder="github token">
        <button type="submit">connect</button>
        <button type="button" hx-post="/test-token" hx-target="#status" hx-swap="innerHTML">test token</button>
    </form>

    <div id="file-browser">
        <button hx-get="/files" hx-target="#file-list" hx-swap="innerHTML">load repository files</button>
        <div id="file-list"></div>
    </div>

    <div id="editor-section" style="display:none;">
        <h3 id="current-file">Editing: </h3>
        <form hx-post="/commit" hx-target="#status" hx-swap="innerHTML">
            <input type="hidden" name="filePath" id="current-file-path">
            <input type="hidden" name="sha" id="current-file-sha">
            <textarea name="content" id="file-content" rows="20" cols="80"></textarea>
            <br>
            <button type="submit">commit change</button>
        </form>
    </div>

    <form hx-post="/create-pr" hx-target="#status" hx-swap="innerHTML">
        <input type="text" name="title" placeholder="pr title">
        <br>
        <textarea name="body" placeholder="pr description"></textarea>
        <br>
        <input type="hidden" name="content" value="">
        <input type="hidden" name="filePath" value="">
        <button type="submit" onclick="
            this.form.content.value = document.getElementById('file-content').value;
            this.form.filePath.value = document.getElementById('current-file-path').value;
        ">create pr</button>
    </form>

    <div id="prs-section">
        <button hx-get="/prs" hx-target="#prs-list" hx-swap="innerHTML">load prs</button>
        <div id="prs-list"></div>
    </div>

    <hr>
    <h3>OG Image Generator</h3>
    <button onclick="generateAndUploadOGImage()">generate & upload og-image.png</button>

    <div id="status"></div>

    <script>
        async function loadFile(filePath) {
            try {
                const response = await fetch(`/file/${encodeURIComponent(filePath)}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('status').innerHTML = `<p>Error: ${data.error}</p>`;
                    return;
                }

                // Show editor section
                document.getElementById('editor-section').style.display = 'block';

                // Set file info
                document.getElementById('current-file').textContent = `Editing: ${filePath}`;
                document.getElementById('current-file-path').value = filePath;
                document.getElementById('current-file-sha').value = data.sha;
                document.getElementById('file-content').value = data.content;

                document.getElementById('status').innerHTML = `<p>Loaded ${filePath}</p>`;

            } catch (error) {
                document.getElementById('status').innerHTML = `<p>Error loading file: ${error.message}</p>`;
            }
        }

        async function generateAndUploadOGImage() {
            const status = document.getElementById('status');
            status.innerHTML = '<p>Generating image...</p>';

            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.width = 600;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');

            // Background gradient
            const gradient = ctx.createLinearGradient(0, 0, 600, 400);
            gradient.addColorStop(0, '#111');
            gradient.addColorStop(1, '#333');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 600, 400);

            // Title text
            ctx.font = 'bold 48px Arial';
            ctx.fillStyle = '#00ffaa';
            ctx.textAlign = 'center';
            ctx.fillText('world-world', 300, 180);

            // Subtitle
            ctx.font = '24px Arial';
            ctx.fillStyle = '#888';
            ctx.fillText('Edit GitHub repos on the go', 300, 240);

            // Convert to base64 (remove data:image/png;base64, prefix)
            const base64 = canvas.toDataURL('image/png').split(',')[1];

            status.innerHTML = '<p>Uploading to GitHub...</p>';

            // Upload to GitHub
            try {
                const response = await fetch('/commit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: base64,
                        filePath: 'og-image.png'
                    })
                });

                const result = await response.json();
                if (result.error) {
                    status.innerHTML = `<p>Error: ${result.error}</p>`;
                } else {
                    status.innerHTML = `<p>âœ… ${result.success} Image URL: https://raw.githubusercontent.com/compusophy/world-world/main/og-image.png</p>`;
                }
            } catch (error) {
                status.innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }
    </script>
    
    <!-- Farcaster Mini App SDK -->
    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk'
        // Notify the Farcaster client that the Mini App is ready
        await sdk.actions.ready()
    </script>
</body>
</html>